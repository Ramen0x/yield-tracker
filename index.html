<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yield Token Tracker - Real vs Advertised APY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-[1800px]">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-1">Yield Token Tracker</h1>
                    <p class="text-gray-400 text-sm">Real APY calculated from on-chain price snapshots</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500" id="last-update">Loading...</div>
                    <div class="text-xs text-gray-600 mt-1">Updates hourly</div>
                </div>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center py-32">
            <div class="text-center">
                <div class="text-lg text-gray-400 mb-2">Loading data from Maple Finance...</div>
                <div class="text-sm text-gray-600">Fetching on-chain prices</div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content" class="hidden space-y-6">
            <!-- Token sections will be inserted here -->
        </div>
    </div>

    <script>
        let allData = null;
        let charts = {};

        async function loadData() {
            try {
                const response = await fetch('/data/snapshots.json');
                allData = await response.json();
                
                if (allData.lastUpdate) {
                    const date = new Date(allData.lastUpdate);
                    document.getElementById('last-update').textContent = 
                        `Last update: ${date.toLocaleString('en-US', { 
                            month: 'short', day: 'numeric', 
                            hour: '2-digit', minute: '2-digit', timeZone: 'UTC' 
                        })} UTC`;
                }
                
                renderTokens();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="text-center"><div class="text-red-400">Failed to load data</div></div>';
            }
        }

        function renderTokens() {
            const container = document.getElementById('content');
            container.innerHTML = '';

            for (const [tokenId, tokenData] of Object.entries(allData.tokens)) {
                if (tokenData.snapshots.length === 0) continue;
                
                const section = createTokenSection(tokenId, tokenData);
                container.appendChild(section);
            }
        }

        function createTokenSection(tokenId, tokenData) {
            const section = document.createElement('div');
            section.className = 'bg-gray-800 border border-gray-700 rounded-lg overflow-hidden';
            
            const latest = tokenData.snapshots[tokenData.snapshots.length - 1];
            
            // APR metrics
            const ranges = [
                { key: 'apr_6h', label: '6h', desc: '6 hour' },
                { key: 'apr_12h', label: '12h', desc: '12 hour' },
                { key: 'apr_24h', label: '24h', desc: '24 hour' },
                { key: 'apr_3d', label: '3d', desc: '3 day' },
                { key: 'apr_7d', label: '7d', desc: '7 day' },
                { key: 'apr_14d', label: '14d', desc: '14 day' },
                { key: 'apr_30d', label: '30d', desc: '30 day' }
            ];

            const aprMetrics = ranges.map(r => {
                const value = latest[r.key];
                let display, colorClass, textColor;
                
                if (value != null) {
                    display = value.toFixed(2) + '%';
                    if (value > 0) {
                        colorClass = 'bg-green-900/30 border-green-700/50';
                        textColor = 'text-green-400';
                    } else if (value < 0) {
                        colorClass = 'bg-red-900/30 border-red-700/50';
                        textColor = 'text-red-400';
                    } else {
                        colorClass = 'bg-gray-700/30 border-gray-600';
                        textColor = 'text-gray-400';
                    }
                } else {
                    display = '-';
                    colorClass = 'bg-gray-700/30 border-gray-600';
                    textColor = 'text-gray-500';
                }

                return `
                    <div class="border ${colorClass} rounded p-3">
                        <div class="text-xs text-gray-400 mb-1">${r.desc}</div>
                        <div class="text-2xl font-bold font-mono ${textColor}">${display}</div>
                        <div class="text-xs text-gray-500 mt-1">APR</div>
                    </div>
                `;
            }).join('');

            section.innerHTML = `
                <div class="p-4 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div>
                                <h2 class="text-xl font-bold">${tokenData.symbol}</h2>
                                <p class="text-sm text-gray-400">${tokenData.name}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">${tokenData.protocol}</div>
                            <div class="text-xs text-gray-600">${tokenData.chain}</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-[1fr_400px] gap-6 p-6">
                    <!-- Chart -->
                    <div>
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold mb-1">Share Price History</h3>
                            <div class="text-sm text-gray-400">
                                Current: <span class="font-mono text-green-400">${latest.price.toFixed(8)}</span>
                                <span class="text-gray-600 ml-2">(${tokenData.snapshots.length} snapshots)</span>
                            </div>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-4" style="height: 400px;">
                            <canvas id="chart-${tokenId}"></canvas>
                        </div>
                    </div>

                    <!-- APR Metrics -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Realized APR</h3>
                        <div class="space-y-3">
                            ${aprMetrics}
                        </div>
                        <div class="mt-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                            <div class="text-xs text-gray-400 mb-2">About APR Calculation</div>
                            <div class="text-xs text-gray-500 leading-relaxed">
                                APR is calculated from actual on-chain share price changes and annualized. 
                                Values appear as data accumulates over time. Negative values indicate price decrease.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Create chart after DOM insertion
            setTimeout(() => {
                createChart(tokenId, tokenData);
            }, 0);

            return section;
        }

        function createChart(tokenId, tokenData) {
            const canvas = document.getElementById(`chart-${tokenId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if any
            if (charts[tokenId]) {
                charts[tokenId].destroy();
            }

            const labels = tokenData.snapshots.map(s => 
                new Date(s.timestamp).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            );
            const prices = tokenData.snapshots.map(s => s.price);

            // Calculate price range for better y-axis scaling
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const padding = (maxPrice - minPrice) * 0.1 || 0.0001;

            charts[tokenId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Share Price',
                        data: prices,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgb(34, 197, 94)',
                        pointBorderColor: '#1f2937',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#9ca3af',
                            bodyColor: '#f3f4f6',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function(items) {
                                    return items[0].label;
                                },
                                label: function(context) {
                                    return `Price: ${context.parsed.y.toFixed(8)}`;
                                },
                                afterLabel: function(context) {
                                    const snap = tokenData.snapshots[context.dataIndex];
                                    const lines = [];
                                    const ranges = ['6h', '12h', '24h', '3d', '7d', '14d', '30d'];
                                    ranges.forEach(r => {
                                        const key = `apr_${r}`;
                                        if (snap[key] != null) {
                                            lines.push(`${r} APR: ${snap[key].toFixed(2)}%`);
                                        }
                                    });
                                    return lines.length > 0 ? ['\n', ...lines] : [];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: minPrice - padding,
                            max: maxPrice + padding,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#9ca3af',
                                font: { family: 'monospace' },
                                callback: function(value) {
                                    return value.toFixed(8);
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // Load data on page load
        loadData();

        // Auto-refresh every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
