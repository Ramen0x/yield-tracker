<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yield Token Tracker - Real vs Advertised APY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .font-mono, .tabular-nums {
            font-family: 'Space Mono', monospace;
            font-variant-numeric: tabular-nums;
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05);
        }

        .delta-positive {
            color: #059669;
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
        }

        .delta-negative {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .delta-neutral {
            color: #6b7280;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }

        .time-range-button {
            transition: all 0.15s;
            cursor: pointer;
            background: transparent;
            color: #6b7280;
            font-weight: 500;
        }

        .time-range-button:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .time-range-button.active {
            background: #64748b;
            color: white;
        }

        /* Clean scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Protocol accent bar */
        .protocol-accent {
            width: 3px;
            border-radius: 2px;
        }

        /* Institutional protocol headers */
        .protocol-header {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .protocol-header:hover {
            background: linear-gradient(135deg, #f5f5f5 0%, #efefef 100%);
        }

        .protocol-logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.5px;
            color: white;
            box-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }

        .protocol-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .protocol-header:hover .protocol-logo {
            transform: scale(1.05);
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.2);
        }

        .protocol-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            letter-spacing: -0.025em;
        }

        .protocol-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .protocol-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .protocol-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .protocol-tokens-preview {
            display: flex;
            gap: 6px;
        }

        .token-pill {
            padding: 4px 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
            color: #374151;
            transition: all 0.15s ease;
        }

        .token-pill:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .expand-indicator {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .protocol-header:hover .expand-indicator {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-[1800px]">
        <!-- Header -->
        <header class="mb-8 animate-fade-in">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-semibold text-gray-900 mb-1">
                        Yield Token Tracker
                    </h1>
                    <p class="text-gray-500 text-sm">Real APY calculated from on-chain price snapshots vs advertised rates</p>
                </div>
                <div class="flex items-center gap-3">
                    <button
                        id="collapse-all-btn"
                        class="px-4 py-2 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors flex items-center gap-2 shadow-sm"
                        onclick="toggleAllSections()"
                    >
                        <svg class="w-4 h-4" id="collapse-all-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                        <span id="collapse-all-text">Expand All</span>
                    </button>
                    <button
                        id="export-all-btn"
                        class="px-4 py-2 bg-slate-600 hover:bg-slate-700 rounded-lg text-sm font-medium text-white transition-colors flex items-center gap-2 shadow-sm"
                        onclick="exportAllToCSV()"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Export
                    </button>
                    <div class="text-right">
                        <div class="text-xs text-gray-500" id="last-update">Loading...</div>
                        <div class="text-xs text-gray-400 mt-1">Updates every 10 min</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- APR Comparison Section -->
        <section id="comparison-section" class="mb-6 hidden animate-fade-in">
            <div class="card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Avg 1h APR (Last 24h)</h2>
                    <span class="text-xs text-gray-400">Average of 1h APR readings · vs previous 24h period</span>
                </div>
                <div id="comparison-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Error Boundary -->
        <div id="error-container" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-red-800 mb-1">Error Loading Data</h3>
                    <p class="text-sm text-red-600" id="error-message"></p>
                </div>
                <button onclick="retryLoad()" class="text-xs text-red-600 hover:text-red-800 underline font-medium">Retry</button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="space-y-6">
            <div class="card overflow-hidden animate-fade-in">
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg loading-skeleton"></div>
                            <div>
                                <div class="h-5 w-32 loading-skeleton rounded mb-2"></div>
                                <div class="h-4 w-24 loading-skeleton rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="h-64 loading-skeleton rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden py-32">
            <div class="text-center max-w-md mx-auto">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                </svg>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Data Available</h3>
                <p class="text-gray-500">Waiting for snapshot data to be collected. Check back soon.</p>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content" class="hidden space-y-4">
            <!-- Token sections will be inserted here -->
        </div>

        <!-- Methodology Section -->
        <section id="methodology-section" class="mt-12 mb-8 hidden">
            <div class="card p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Methodology
                </h2>
                <div class="grid md:grid-cols-2 gap-6 text-sm text-gray-600">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">How APR is Calculated</h3>
                        <p class="mb-3">APR is calculated by measuring the actual change in share price over time, then annualizing the return. This reflects the real yield earned by depositors.</p>
                        <p class="font-mono text-xs bg-gray-50 p-3 rounded-lg border border-gray-100">
                            APR = ((Price_end / Price_start) - 1) × (365 × 24 / hours) × 100
                        </p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Data Collection</h3>
                        <ul class="space-y-2">
                            <li class="flex items-start gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 flex-shrink-0"></span>
                                <span>Share prices fetched every 10 minutes from on-chain sources</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 flex-shrink-0"></span>
                                <span>APR calculated over multiple timeframes (1h, 3h, 6h, 12h, 24h, 3d, 7d, 14d, 21d, 30d)</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 flex-shrink-0"></span>
                                <span>Historical data stored for trend analysis and comparison</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Error Boundary
        class ErrorBoundary {
            static showError(error, context = '') {
                console.error(`Error in ${context}:`, error);
                const errorContainer = document.getElementById('error-container');
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = `${context ? context + ': ' : ''}${error.message || error}`;
                errorContainer.classList.remove('hidden');
            }

            static hideError() {
                document.getElementById('error-container').classList.add('hidden');
            }
        }

        // Global state
        let allData = null;
        let charts = {};
        let timeRanges = {};
        let chartModes = {};
        let aprTimeframes = {};
        let showAsAPY = {};
        let hiddenDatasets = {};
        
        function aprToApy(apr, periodHours = 24) {
            if (apr === null || apr === undefined) return null;
            const periodsPerYear = (365 * 24) / periodHours;
            const ratePerPeriod = apr / 100 / periodsPerYear;
            const apy = (Math.pow(1 + ratePerPeriod, periodsPerYear) - 1) * 100;
            return apy;
        }

        // Copy to clipboard with visual feedback
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<svg class="w-3.5 h-3.5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
            }).catch(err => console.error('Copy failed:', err));
        }

        // Protocol branding - colors and logos (DeFi Llama icons)
        const protocolBranding = {
            'Maple Finance': { 
                color: '#1e3a5f', 
                logo: 'https://icons.llamao.fi/icons/protocols/maple-finance'
            },
            'Ethena': { 
                color: '#0ea5e9', 
                logo: 'https://icons.llamao.fi/icons/protocols/ethena'
            },
            'Resolv': { 
                color: '#6366f1', 
                logo: 'https://icons.llamao.fi/icons/protocols/resolv'
            },
            'Cap Finance': { 
                color: '#22c55e', 
                logo: null  // DeFi Llama has wrong logo for cap.app
            },
            'Reservoir': { 
                color: '#3b82f6', 
                logo: 'https://icons.llamao.fi/icons/protocols/reservoir-protocol'
            },
            'Avant': { 
                color: '#f59e0b', 
                logo: 'https://icons.llamao.fi/icons/protocols/avant-protocol'
            },
            'Superstate': { 
                color: '#ec4899', 
                logo: 'https://icons.llamao.fi/icons/protocols/superstate'
            },
            'Yuzu': { 
                color: '#facc15', 
                logo: 'https://icons.llamao.fi/icons/protocols/yuzu-money'
            },
            'Midas': { 
                color: '#06b6d4', 
                logo: 'https://icons.llamao.fi/icons/protocols/midas-rwa'
            },
            'Sky Money': { 
                color: '#8b5cf6', 
                logo: 'https://icons.llamao.fi/icons/protocols/sky'
            },
            'Neutrl': { 
                color: '#64748b', 
                logo: 'https://icons.llamao.fi/icons/protocols/neutrl'
            },
            'Strata': { 
                color: '#14b8a6', 
                logo: 'https://icons.llamao.fi/icons/protocols/strata'
            }
        };

        // Protocol-specific default time ranges
        const protocolDefaults = {
            'Midas': '7d',
            'Avant': '3d',
            'Superstate': '7d'
        };
        
        // Ethena and Resolv now shown as separate protocols (not grouped under Basis Trading)
        const protocolCategories = {
            'Strata': 'Ethena'  // Strata tokens grouped under Ethena
        };
        
        let expandedSections = {};
        let advertisedAPY = {};

        async function loadAdvertisedAPY() {
            try {
                const response = await fetch('/advertised-apy.json');
                const data = await response.json();
                advertisedAPY = Object.entries(data.rates).reduce((acc, [key, value]) => {
                    acc[key] = value.apy;
                    return acc;
                }, {});
            } catch (error) {
                console.warn('Could not load advertised APY data:', error);
                advertisedAPY = {
                    'syrupUSDC': 10.5,
                    'syrupUSDT': 9.8,
                    'sUSDe': 12.0,
                    'RLP': 15.5,
                    'wstUSDR': 8.2
                };
            }
        }

        async function loadData() {
            await loadAdvertisedAPY();
            try {
                ErrorBoundary.hideError();
                const cacheBuster = `?t=${Date.now()}`;
                const response = await fetch('https://axjvwtztf5syd3si.public.blob.vercel-storage.com/snapshots.json' + cacheBuster);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                allData = await response.json();

                if (!allData || !allData.tokens) {
                    throw new Error('Invalid data format');
                }

                if (allData.lastUpdate) {
                    const date = new Date(allData.lastUpdate);
                    document.getElementById('last-update').textContent =
                        `Last update: ${date.toLocaleString('en-US', {
                            month: 'short', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        })}`;
                }

                const hasData = Object.values(allData.tokens).some(t => t.snapshots && t.snapshots.length > 0);

                if (!hasData) {
                    showEmptyState();
                } else {
                    renderTokens();
                    renderComparisonSection();
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('content').classList.remove('hidden');
                    document.getElementById('methodology-section')?.classList.remove('hidden');
                }
            } catch (error) {
                ErrorBoundary.showError(error, 'Loading data');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function showEmptyState() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }

        function retryLoad() {
            ErrorBoundary.hideError();
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            loadData();
        }

        function renderTokens() {
            const container = document.getElementById('content');
            container.innerHTML = '';
            container.className = 'space-y-4';

            const tokensByProtocol = {};
            for (const [tokenId, tokenData] of Object.entries(allData.tokens)) {
                if (tokenData.snapshots.length === 0) continue;
                const protocol = tokenData.protocol || 'Other';
                const category = protocolCategories[protocol] || protocol;
                if (!tokensByProtocol[category]) {
                    tokensByProtocol[category] = [];
                }
                tokensByProtocol[category].push({ tokenId, tokenData });
            }

            let hasRendered = false;
            
            const protocolOrder = [
                'Maple Finance',
                'Ethena',
                'Resolv',
                'Cap Finance',
                'Yuzu',
                'Midas',
                'Avant',
                'Reservoir',
                'Superstate',
                'Sky Money',
                'Neutrl'
            ];
            const sortedProtocols = Object.keys(tokensByProtocol).sort((a, b) => {
                const aIdx = protocolOrder.indexOf(a);
                const bIdx = protocolOrder.indexOf(b);
                if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
                if (aIdx !== -1) return -1;
                if (bIdx !== -1) return 1;
                return a.localeCompare(b);
            });
            
            for (const protocol of sortedProtocols) {
                const tokens = tokensByProtocol[protocol];
                const branding = protocolBranding[protocol] || { color: '#6b7280' };
                
                if (expandedSections[protocol] === undefined) {
                    expandedSections[protocol] = false;
                }
                const isExpanded = expandedSections[protocol];
                
                const section = document.createElement('div');
                section.className = 'card overflow-hidden';
                
                const latestPrices = tokens.map(t => {
                    const latest = t.tokenData.snapshots[t.tokenData.snapshots.length - 1];
                    return { symbol: t.tokenData.symbol, price: latest.price, apr7d: latest.apr_7d };
                });
                
                // Get protocol initials for logo
                const initials = protocol.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                
                const logoHtml = branding.logo 
                    ? `<img src="${branding.logo}" alt="${protocol}" onerror="this.parentElement.innerHTML='${initials}'">`
                    : initials;
                
                section.innerHTML = `
                    <div 
                        class="protocol-header px-5 py-4 cursor-pointer flex items-center justify-between"
                        onclick="toggleProtocolSection('${protocol}')"
                    >
                        <div class="flex items-center gap-4">
                            <div class="protocol-logo" style="background: ${branding.logo ? 'white' : `linear-gradient(135deg, ${branding.color} 0%, ${branding.color}dd 100%)`}; ${branding.logo ? 'border: 1px solid #e5e7eb;' : ''}">
                                ${logoHtml}
                            </div>
                            <div>
                                <h2 class="protocol-name">${protocol}</h2>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="protocol-badge">
                                        <span class="protocol-badge-dot" style="background: ${branding.color}"></span>
                                        ${tokens.length} token${tokens.length > 1 ? 's' : ''}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="protocol-tokens-preview hidden md:flex">
                                ${latestPrices.slice(0, 3).map(p => `<span class="token-pill">${p.symbol}</span>`).join('')}
                                ${latestPrices.length > 3 ? `<span class="token-pill">+${latestPrices.length - 3}</span>` : ''}
                            </div>
                            <div class="expand-indicator">
                                <svg 
                                    class="w-4 h-4 text-gray-500 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" 
                                    id="chevron-${protocol.replace(/\s+/g, '-')}"
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                >
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div 
                        class="${isExpanded ? '' : 'hidden'}" 
                        id="section-${protocol.replace(/\s+/g, '-')}"
                    >
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 p-5 bg-gradient-to-b from-gray-50 to-white" id="tokens-${protocol.replace(/\s+/g, '-')}">
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
                
                const tokensGrid = document.getElementById(`tokens-${protocol.replace(/\s+/g, '-')}`);
                for (const { tokenId, tokenData } of tokens) {
                    try {
                        const tokenSection = createTokenSection(tokenId, tokenData);
                        tokensGrid.appendChild(tokenSection);
                        hasRendered = true;
                    } catch (error) {
                        ErrorBoundary.showError(error, `Rendering ${tokenId}`);
                    }
                }
            }

            if (!hasRendered) {
                showEmptyState();
            }
        }
        
        function toggleProtocolSection(protocol) {
            const sectionId = `section-${protocol.replace(/\s+/g, '-')}`;
            const chevronId = `chevron-${protocol.replace(/\s+/g, '-')}`;
            const section = document.getElementById(sectionId);
            const chevron = document.getElementById(chevronId);
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                chevron.classList.add('rotate-180');
                expandedSections[protocol] = true;
            } else {
                section.classList.add('hidden');
                chevron.classList.remove('rotate-180');
                expandedSections[protocol] = false;
            }
        }

        function toggleAllSections() {
            const allProtocols = Object.keys(expandedSections);
            const expandedCount = Object.values(expandedSections).filter(v => v).length;
            const shouldExpand = expandedCount < allProtocols.length / 2;
            
            allProtocols.forEach(protocol => {
                const sectionId = `section-${protocol.replace(/\s+/g, '-')}`;
                const chevronId = `chevron-${protocol.replace(/\s+/g, '-')}`;
                const section = document.getElementById(sectionId);
                const chevron = document.getElementById(chevronId);
                
                if (section) {
                    if (shouldExpand) {
                        section.classList.remove('hidden');
                        chevron?.classList.add('rotate-180');
                        expandedSections[protocol] = true;
                    } else {
                        section.classList.add('hidden');
                        chevron?.classList.remove('rotate-180');
                        expandedSections[protocol] = false;
                    }
                }
            });
            
            // Update button text
            const btn = document.getElementById('collapse-all-text');
            if (btn) {
                btn.textContent = shouldExpand ? 'Collapse All' : 'Expand All';
            }
        }

        // Heatmap color function for APR values
        function getHeatmapColor(apr) {
            if (apr === null || apr === undefined || isNaN(apr)) return { bg: '#f3f4f6', text: '#6b7280' };
            if (apr < 0) return { bg: '#fef2f2', border: '#fecaca', text: '#dc2626' };
            if (apr < 2) return { bg: '#fff7ed', border: '#fed7aa', text: '#c2410c' };
            if (apr < 4) return { bg: '#fefce8', border: '#fef08a', text: '#a16207' };
            if (apr < 6) return { bg: '#f0fdf4', border: '#bbf7d0', text: '#15803d' };
            if (apr < 10) return { bg: '#ecfdf5', border: '#6ee7b7', text: '#059669' };
            return { bg: '#d1fae5', border: '#34d399', text: '#047857' };
        }

        function renderComparisonSection() {
            const grid = document.getElementById('comparison-grid');
            const section = document.getElementById('comparison-section');
            if (!grid || !allData?.tokens) return;
            
            const now = Date.now();
            const h24 = 24 * 60 * 60 * 1000;
            
            const comparisons = Object.entries(allData.tokens).map(([tokenId, data]) => {
                if (!data.snapshots || data.snapshots.length < 2) return null;
                
                // Get snapshots from last 24h and previous 24h
                const last24h = data.snapshots.filter(s => (now - s.timestamp) <= h24);
                const prev24h = data.snapshots.filter(s => (now - s.timestamp) > h24 && (now - s.timestamp) <= h24 * 2);
                
                // Calculate average of 1h APR for each period
                const avg1hAprLast24h = last24h.length > 0 
                    ? last24h.filter(s => s.apr_1h != null).reduce((sum, s) => sum + s.apr_1h, 0) / last24h.filter(s => s.apr_1h != null).length
                    : null;
                const avg1hAprPrev24h = prev24h.length > 0 
                    ? prev24h.filter(s => s.apr_1h != null).reduce((sum, s) => sum + s.apr_1h, 0) / prev24h.filter(s => s.apr_1h != null).length
                    : null;
                
                const change = avg1hAprLast24h != null && avg1hAprPrev24h != null ? avg1hAprLast24h - avg1hAprPrev24h : null;
                return { symbol: data.symbol, currentApr: avg1hAprLast24h, prevApr: avg1hAprPrev24h, change, dataPoints: last24h.length };
            }).filter(Boolean).sort((a, b) => (b.currentApr || 0) - (a.currentApr || 0));
            
            grid.innerHTML = comparisons.map(c => {
                const colors = getHeatmapColor(c.currentApr);
                const changeIcon = c.change > 0 ? '↑' : c.change < 0 ? '↓' : '→';
                const changeColor = c.change > 0 ? '#059669' : c.change < 0 ? '#dc2626' : '#6b7280';
                return `
                    <div class="rounded-lg p-3 transition-all hover:scale-[1.02] cursor-default" 
                         style="background: ${colors.bg}; border: 1px solid ${colors.border || '#e5e7eb'};">
                        <div class="font-semibold text-sm font-mono" style="color: ${colors.text}">${c.symbol}</div>
                        <div class="text-2xl font-mono font-bold mt-1" style="color: ${colors.text}">${c.currentApr?.toFixed(2) || '—'}%</div>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="text-xs font-medium" style="color: ${changeColor}">${changeIcon} ${c.change != null ? Math.abs(c.change).toFixed(2) : '—'}%</span>
                            <span class="text-xs text-gray-400">vs 24h ago</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            section.classList.remove('hidden');
        }

        // Block explorers for contract links
        const blockExplorers = {
            'ethereum': 'https://etherscan.io/address/',
            'eth': 'https://etherscan.io/address/',
            'mainnet': 'https://etherscan.io/address/',
            'avalanche': 'https://snowtrace.io/address/',
            'avax': 'https://snowtrace.io/address/',
            'plasma': 'https://plasma-explorer.com/address/',
            'arbitrum': 'https://arbiscan.io/address/',
            'optimism': 'https://optimistic.etherscan.io/address/',
            'polygon': 'https://polygonscan.com/address/',
            'base': 'https://basescan.org/address/'
        };

        function getExplorerUrl(chain, address) {
            if (!address) return null;
            const chainLower = (chain || 'ethereum').toLowerCase();
            const baseUrl = blockExplorers[chainLower] || blockExplorers['ethereum'];
            return baseUrl + address;
        }

        function createTokenSection(tokenId, tokenData) {
            const section = document.createElement('div');
            section.className = 'bg-white border border-gray-100 rounded-xl overflow-hidden shadow-sm animate-fade-in';

            const latest = tokenData.snapshots[tokenData.snapshots.length - 1];
            const previous = tokenData.snapshots.length > 1 ? tokenData.snapshots[tokenData.snapshots.length - 2] : null;

            const priceChange = previous ? ((latest.price - previous.price) / previous.price * 100) : 0;
            const priceChangeClass = priceChange > 0 ? 'text-emerald-600' : priceChange < 0 ? 'text-red-500' : 'text-gray-400';
            const priceChangeIcon = priceChange > 0 ? '↑' : priceChange < 0 ? '↓' : '→';

            const branding = protocolBranding[tokenData.protocol] || { color: '#6b7280' };

            const advertised = advertisedAPY[tokenData.symbol];
            const realized = latest.apr_30d || latest.apr_7d || latest.apr_24h;
            let deltaHTML = '';

            if (advertised && realized !== null && realized !== undefined) {
                const delta = realized - advertised;
                const deltaClass = delta > 0 ? 'delta-positive' : delta < 0 ? 'delta-negative' : 'delta-neutral';
                const deltaSign = delta > 0 ? '+' : '';
                deltaHTML = `
                    <div class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-500">Advertised APY</span>
                            <span class="font-mono text-sm text-slate-600">${advertised.toFixed(2)}%</span>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-500">Realized APR (30d)</span>
                            <span class="font-mono text-sm text-gray-700">${realized.toFixed(2)}%</span>
                        </div>
                        <div class="pt-2 border-t border-gray-200 flex items-center justify-between">
                            <span class="text-xs font-medium text-gray-500">Difference</span>
                            <span class="px-2 py-1 rounded text-xs font-mono font-semibold ${deltaClass}">
                                ${deltaSign}${delta.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;
            }

            const timeframes = [
                { key: 'apr_1h', label: '1H' },
                { key: 'apr_3h', label: '3H' },
                { key: 'apr_6h', label: '6H' },
                { key: 'apr_12h', label: '12H' },
                { key: 'apr_24h', label: '1D' },
                { key: 'apr_3d', label: '3D' },
                { key: 'apr_7d', label: '7D' },
                { key: 'apr_14d', label: '14D' },
                { key: 'apr_21d', label: '21D' },
                { key: 'apr_30d', label: '30D' }
            ];
            const aprPanels = timeframes.map(t => {
                const val = latest[t.key];
                const display = val != null ? val.toFixed(2) + '%' : '—';
                const extrapolated = latest[t.key + '_extrapolated'];
                return `<div class="bg-white rounded-lg px-3 py-2.5 border border-gray-200 shadow-sm flex justify-between items-center${extrapolated ? ' opacity-50' : ''}">
                    <span class="text-[10px] text-gray-500 font-semibold tracking-wide">${t.label}</span>
                    <span class="text-sm font-mono text-gray-800 font-semibold">${display}</span>
                </div>`;
            }).join('');

            const explorerUrl = getExplorerUrl(tokenData.chain, tokenData.address);
            const shortAddr = tokenData.address ? `${tokenData.address.slice(0, 6)}...${tokenData.address.slice(-4)}` : '';
            const fullAddr = tokenData.address || '';

            section.innerHTML = `
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">${tokenData.symbol}</h2>
                            <p class="text-sm text-gray-500">${tokenData.name}</p>
                        </div>
                        <div class="text-right">
                            ${fullAddr ? `
                            <div class="flex items-center gap-1.5 justify-end">
                                <a href="${explorerUrl}" target="_blank" rel="noopener noreferrer" 
                                   class="font-mono text-xs text-gray-500 hover:text-gray-700 transition-colors"
                                   title="View on explorer">
                                    ${shortAddr}
                                </a>
                                <button 
                                    onclick="copyToClipboard('${fullAddr}', this)" 
                                    class="p-1 rounded hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors"
                                    title="Copy address">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                                <a href="${explorerUrl}" target="_blank" rel="noopener noreferrer" 
                                   class="p-1 rounded hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors"
                                   title="Open in explorer">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </a>
                            </div>
                            ` : ''}
                            <div class="text-[10px] text-gray-400 mt-1">${tokenData.chain}</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-[1fr_160px] gap-4 p-4">
                    <!-- Chart -->
                    <div>
                        <!-- Header row -->
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-900">Price History</h3>
                                <div class="text-xs text-gray-500">
                                    <span class="font-mono text-emerald-600 font-medium">${latest.price.toFixed(6)}</span>
                                    <span class="text-gray-400 ml-1">(${tokenData.snapshots.length} pts)</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <button
                                    class="p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition text-gray-400 hover:text-gray-700"
                                    onclick="toggleChartMode('${tokenId}')"
                                    id="chart-mode-${tokenId}"
                                    title="Toggle APR overlay"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                </button>
                                <button
                                    class="p-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition text-gray-400 hover:text-gray-700"
                                    onclick="exportTokenToCSV('${tokenId}')"
                                    title="Export CSV"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Controls row -->
                        <div class="flex flex-wrap items-center gap-3 mb-3 p-2 bg-gray-50 rounded-lg border border-gray-100">
                            <!-- Range selector -->
                            <div class="flex items-center gap-1.5">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wide font-medium">Range</span>
                                <div class="flex rounded-lg overflow-hidden border border-gray-200 bg-white">
                                    ${['3h', '6h', '12h', '24h', '7d', '30d', 'all'].map(range => {
                                        const defaultRange = protocolDefaults[tokenData.protocol] || '24h';
                                        return `<button
                                            class="time-range-button px-2.5 py-1.5 text-[11px] border-r border-gray-200 last:border-r-0 ${range === defaultRange ? 'active' : ''}"
                                            onclick="changeTimeRange('${tokenId}', '${range}')"
                                            data-token="${tokenId}"
                                            data-range="${range}"
                                        >${range}</button>`;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- APR timeframe selector -->
                            <div class="flex items-center gap-1.5">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wide font-medium">APR</span>
                                <div class="flex rounded-lg overflow-hidden border border-gray-200 bg-white">
                                    ${['1h', '3h', '6h', '24h', '7d'].map(tf => `
                                        <button
                                            class="time-range-button px-2.5 py-1.5 text-[11px] border-r border-gray-200 last:border-r-0 ${tf === '1h' ? 'active' : ''}"
                                            onclick="changeAprTimeframe('${tokenId}', '${tf}')"
                                            data-token="${tokenId}"
                                            data-apr="${tf}"
                                        >${tf}</button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- APR/APY toggle -->
                            <button
                                class="time-range-button px-3 py-1.5 text-[11px] rounded-lg border border-gray-200 bg-white active"
                                onclick="toggleApyMode('${tokenId}')"
                                data-token="${tokenId}"
                                data-apy-toggle="true"
                            >APR</button>
                        </div>

                        <div class="bg-white rounded-xl p-4 border border-gray-100" style="height: 400px;" id="chart-loading-${tokenId}">
                            <canvas id="chart-${tokenId}"></canvas>
                        </div>
                    </div>

                    <!-- APR Metrics - Single Column Panels -->
                    <div class="flex flex-col h-full">
                        <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-100">
                            <h3 class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Realized APR</h3>
                            ${latest.data_hours ? `<span class="text-[10px] text-gray-400 font-mono">${latest.data_hours.toFixed(0)}h data</span>` : ''}
                        </div>
                        <div class="flex flex-col gap-1.5 flex-1">
                            ${aprPanels}
                        </div>
                    </div>
                </div>
            `;

            timeRanges[tokenId] = protocolDefaults[tokenData.protocol] || '24h';
            chartModes[tokenId] = 'dual';
            hiddenDatasets[tokenId] = { 1: true };
            aprTimeframes[tokenId] = '1h';

            setTimeout(() => {
                try {
                    createChart(tokenId, tokenData);
                } catch (error) {
                    ErrorBoundary.showError(error, `Creating chart for ${tokenId}`);
                }
            }, 0);

            return section;
        }

        function changeTimeRange(tokenId, range) {
            timeRanges[tokenId] = range;

            const buttons = document.querySelectorAll(`[data-token="${tokenId}"][data-range]`);
            buttons.forEach(btn => {
                if (btn.dataset.range === range) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            createChart(tokenId, allData.tokens[tokenId]);
        }

        function changeAprTimeframe(tokenId, timeframe) {
            aprTimeframes[tokenId] = timeframe;

            const buttons = document.querySelectorAll(`[data-token="${tokenId}"][data-apr]`);
            buttons.forEach(btn => {
                if (btn.dataset.apr === timeframe) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            createChart(tokenId, allData.tokens[tokenId]);
        }

        function toggleApyMode(tokenId) {
            showAsAPY[tokenId] = !showAsAPY[tokenId];
            
            const btn = document.querySelector(`[data-token="${tokenId}"][data-apy-toggle]`);
            if (btn) {
                btn.textContent = showAsAPY[tokenId] ? 'APY' : 'APR';
            }
            
            createChart(tokenId, allData.tokens[tokenId]);
        }

        function toggleChartMode(tokenId) {
            chartModes[tokenId] = chartModes[tokenId] === 'single' ? 'dual' : 'single';
            createChart(tokenId, allData.tokens[tokenId]);
        }

        function filterSnapshotsByTimeRange(snapshots, range) {
            if (range === 'all') return snapshots;

            const now = Date.now();
            const ranges = {
                '3h': 3 * 60 * 60 * 1000,
                '6h': 6 * 60 * 60 * 1000,
                '12h': 12 * 60 * 60 * 1000,
                '24h': 24 * 60 * 60 * 1000,
                '7d': 7 * 24 * 60 * 60 * 1000,
                '30d': 30 * 24 * 60 * 60 * 1000
            };

            const cutoff = now - ranges[range];
            return snapshots.filter(s => s.timestamp >= cutoff);
        }

        function createChart(tokenId, tokenData) {
            const canvas = document.getElementById(`chart-${tokenId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            if (charts[tokenId]) {
                charts[tokenId].destroy();
            }

            const range = timeRanges[tokenId] || 'all';
            const mode = chartModes[tokenId] || 'single';
            const filteredSnapshots = filterSnapshotsByTimeRange(tokenData.snapshots, range);

            if (filteredSnapshots.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#9ca3af';
                ctx.font = '14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data for selected time range', canvas.width / 2, canvas.height / 2);
                return;
            }

            const labels = filteredSnapshots.map(s => new Date(s.timestamp));
            const prices = filteredSnapshots.map(s => s.price);
            const selectedAprTf = aprTimeframes[tokenId] || '1h';
            const aprKey = `apr_${selectedAprTf}`;
            const useAPY = showAsAPY[tokenId] || false;
            const tfHours = { '1h': 1, '3h': 3, '6h': 6, '12h': 12, '24h': 24, '3d': 72, '7d': 168 };
            const aprData = filteredSnapshots.map(s => {
                const apr = s[aprKey];
                return useAPY ? aprToApy(apr, tfHours[selectedAprTf] || 24) : apr;
            });
            const rateLabel = useAPY ? 'APY' : 'APR';

            // Use percentile-based scaling to exclude outliers
            const sortedPrices = [...prices].sort((a, b) => a - b);
            const p5Index = Math.floor(sortedPrices.length * 0.02);
            const p95Index = Math.ceil(sortedPrices.length * 0.98) - 1;
            const minPrice = sortedPrices[Math.max(0, p5Index)];
            const maxPrice = sortedPrices[Math.min(sortedPrices.length - 1, p95Index)];
            const priceRange = maxPrice - minPrice;
            const padding = priceRange * 0.15 || 0.0001;

            const datasets = [{
                label: 'Share Price',
                data: prices,
                borderColor: '#64748b',
                backgroundColor: 'rgba(99, 102, 241, 0.08)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 4,
                yAxisID: 'y'
            }];

            const scales = {
                y: {
                    type: 'linear',
                    position: 'left',
                    min: minPrice - padding,
                    max: maxPrice + padding,
                    grid: {
                        color: 'rgba(229, 231, 235, 0.8)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#6b7280',
                        font: { family: 'Space Mono', size: 10 },
                        maxTicksLimit: 6,
                        callback: function(value) {
                            return value.toFixed(4);
                        }
                    },
                    title: {
                        display: mode === 'dual',
                        text: 'Price',
                        color: '#6b7280',
                        font: { family: 'Inter', size: 11 }
                    }
                },
                x: {
                    type: 'time',
                    time: {
                        tooltipFormat: 'MMM d, h:mm a',
                        displayFormats: {
                            minute: 'h:mm a',
                            hour: 'h:mm a',
                            day: 'MMM d'
                        }
                    },
                    grid: {
                        color: 'rgba(229, 231, 235, 0.5)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#9ca3af',
                        font: { family: 'Inter', size: 10 },
                        maxTicksLimit: 6
                    }
                }
            };

            if (mode === 'dual' && aprData.some(v => v !== null && v !== undefined)) {
                const validAPRs = aprData.filter(v => v !== null && v !== undefined);
                // Use percentile-based scaling for APR too
                const sortedAPRs = [...validAPRs].sort((a, b) => a - b);
                const aprP5 = Math.floor(sortedAPRs.length * 0.02);
                const aprP95 = Math.ceil(sortedAPRs.length * 0.98) - 1;
                const minAPR = sortedAPRs[Math.max(0, aprP5)];
                const maxAPR = sortedAPRs[Math.min(sortedAPRs.length - 1, aprP95)];
                const aprRange = maxAPR - minAPR;
                const minRange = 0.5;
                const aprPadding = aprRange < minRange ? (minRange - aprRange) / 2 + 0.05 : aprRange * 0.15;

                datasets.push({
                    label: `${selectedAprTf} ${rateLabel}`,
                    data: aprData,
                    borderColor: '#0d9488',
                    backgroundColor: 'rgba(20, 184, 166, 0.08)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    yAxisID: 'y1',
                    spanGaps: true,
                    order: 2
                });

                const avgAPR = validAPRs.reduce((a, b) => a + b, 0) / validAPRs.length;
                const avgLineData = aprData.map(() => avgAPR);
                datasets.push({
                    label: `Avg: ${avgAPR.toFixed(2)}%`,
                    data: avgLineData,
                    borderColor: '#d97706',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    tension: 0,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    yAxisID: 'y1',
                    spanGaps: true,
                    order: 1
                });

                scales.y1 = {
                    type: 'linear',
                    position: 'right',
                    min: minAPR - aprPadding,
                    max: maxAPR + aprPadding,
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        color: '#0d9488',
                        font: { family: 'Space Mono', size: 11 },
                        callback: function(value) {
                            return value.toFixed(2) + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: rateLabel + ' (%)',
                        color: '#0d9488',
                        font: { family: 'Inter', size: 11, weight: '500' }
                    }
                };
            }

            const tokenHidden = hiddenDatasets[tokenId] || {};
            datasets.forEach((ds, i) => {
                if (tokenHidden[i]) ds.hidden = true;
            });

            charts[tokenId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 5,
                            right: 5
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: mode === 'dual',
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: '#374151',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { family: 'Inter', size: 12, weight: '500' },
                                boxWidth: 10,
                                boxHeight: 10,
                                generateLabels: function(chart) {
                                    const datasets = chart.data.datasets;
                                    return datasets.map((dataset, i) => {
                                        const isVisible = chart.isDatasetVisible(i);
                                        const baseColor = dataset.borderColor;
                                        // Use greyed out instead of strikethrough for hidden
                                        return {
                                            text: dataset.label,
                                            fillStyle: isVisible ? baseColor : 'rgba(156, 163, 175, 0.4)',
                                            strokeStyle: isVisible ? baseColor : 'rgba(156, 163, 175, 0.4)',
                                            lineWidth: 2,
                                            hidden: false,  // Never set hidden=true (avoids strikethrough)
                                            index: i,
                                            fontColor: isVisible ? '#374151' : 'rgba(156, 163, 175, 0.5)',
                                            pointStyle: 'circle',
                                            datasetIndex: i
                                        };
                                    });
                                }
                            },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.index;
                                const ci = legend.chart;
                                const isVisible = ci.isDatasetVisible(index);
                                ci.setDatasetVisibility(index, !isVisible);
                                if (!hiddenDatasets[tokenId]) hiddenDatasets[tokenId] = {};
                                hiddenDatasets[tokenId][index] = isVisible;
                                ci.update();
                            }
                        },
                        tooltip: {
                            backgroundColor: 'white',
                            titleColor: '#6b7280',
                            bodyColor: '#111827',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            bodyFont: { family: 'Space Mono' },
                            callbacks: {
                                title: function(items) {
                                    return new Date(items[0].parsed.x).toLocaleString('en-US', {
                                        month: 'short',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                },
                                label: function(context) {
                                    if (context.dataset.label === 'Share Price') {
                                        return `Price: ${context.parsed.y.toFixed(8)}`;
                                    } else if (context.dataset.label.includes('APR') || context.dataset.label.includes('APY')) {
                                        return context.parsed.y !== null ? `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%` : null;
                                    }
                                },
                                afterLabel: function(context) {
                                    const snap = filteredSnapshots[context.dataIndex];
                                    const lines = [];
                                    const ranges = ['6h', '12h', '24h', '3d', '7d', '14d', '30d'];
                                    ranges.forEach(r => {
                                        const key = `apr_${r}`;
                                        if (snap[key] != null) {
                                            lines.push(`${r} APR: ${snap[key].toFixed(2)}%`);
                                        }
                                    });
                                    return lines.length > 0 && context.dataset.label === 'Share Price' ? ['\n', ...lines] : [];
                                }
                            }
                        }
                    },
                    scales
                }
            });
        }

        function exportTokenToCSV(tokenId) {
            const tokenData = allData.tokens[tokenId];
            if (!tokenData) return;

            let csv = 'Timestamp,Price,6h APR,12h APR,24h APR,3d APR,7d APR,14d APR,30d APR\n';

            tokenData.snapshots.forEach(snap => {
                const timestamp = new Date(snap.timestamp).toISOString();
                csv += `${timestamp},${snap.price},`;
                csv += `${snap.apr_6h || ''},${snap.apr_12h || ''},${snap.apr_24h || ''},`;
                csv += `${snap.apr_3d || ''},${snap.apr_7d || ''},${snap.apr_14d || ''},${snap.apr_30d || ''}\n`;
            });

            downloadCSV(csv, `${tokenData.symbol}-yield-data.csv`);
        }

        function exportAllToCSV() {
            if (!allData) return;

            let csv = 'Token,Symbol,Protocol,Chain,Timestamp,Price,6h APR,12h APR,24h APR,3d APR,7d APR,14d APR,30d APR,Advertised APY,Delta\n';

            for (const [tokenId, tokenData] of Object.entries(allData.tokens)) {
                const advertised = advertisedAPY[tokenData.symbol] || '';
                tokenData.snapshots.forEach(snap => {
                    const timestamp = new Date(snap.timestamp).toISOString();
                    const delta = advertised && snap.apr_30d !== null ? (snap.apr_30d - advertised).toFixed(2) : '';
                    csv += `${tokenData.name},${tokenData.symbol},${tokenData.protocol},${tokenData.chain},${timestamp},${snap.price},`;
                    csv += `${snap.apr_6h || ''},${snap.apr_12h || ''},${snap.apr_24h || ''},`;
                    csv += `${snap.apr_3d || ''},${snap.apr_7d || ''},${snap.apr_14d || ''},${snap.apr_30d || ''},`;
                    csv += `${advertised},${delta}\n`;
                });
            }

            downloadCSV(csv, `all-yield-data-${Date.now()}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        loadData();
        setInterval(loadData, 5 * 60 * 1000);

        window.addEventListener('error', (event) => {
            ErrorBoundary.showError(event.error || event.message, 'Global error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            ErrorBoundary.showError(event.reason, 'Unhandled promise rejection');
        });
    </script>
</body>
</html>
