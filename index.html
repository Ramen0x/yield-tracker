<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yield Token Tracker - Real APY vs Advertised</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8">
            <h1 class="text-4xl font-bold mb-2">ðŸ“Š Yield Token Tracker</h1>
            <p class="text-gray-400">Real APY calculated from on-chain price snapshots. Trust, but verify.</p>
        </header>

        <div id="loading" class="text-center py-20">
            <div class="text-xl text-gray-400">Loading data...</div>
        </div>

        <div id="tokens" class="grid gap-6 md:grid-cols-2 hidden"></div>

        <div id="chart-section" class="mt-8 hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold" id="chart-title">Share Price History</h2>
                    <select id="token-select" class="bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        <option value="">Select token...</option>
                    </select>
                </div>
                <canvas id="priceChart" height="100"></canvas>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>Data updated hourly | On-chain snapshots | <span id="last-update">-</span></p>
        </footer>
    </div>

    <script>
        let allData = null;
        let chart = null;

        async function loadData() {
            try {
                const response = await fetch('/data/snapshots.json');
                allData = await response.json();
                renderTokens();
                setupChart();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('tokens').classList.remove('hidden');
                document.getElementById('chart-section').classList.remove('hidden');
                
                if (allData.lastUpdate) {
                    const date = new Date(allData.lastUpdate).toLocaleString();
                    document.getElementById('last-update').textContent = `Last update: ${date}`;
                }
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    '<div class="text-red-400">Failed to load data</div>';
            }
        }

        function renderTokens() {
            const container = document.getElementById('tokens');
            container.innerHTML = '';

            for (const [tokenId, tokenData] of Object.entries(allData.tokens)) {
                if (tokenData.snapshots.length === 0) continue;

                const latest = tokenData.snapshots[tokenData.snapshots.length - 1];
                const card = createTokenCard(tokenId, tokenData, latest);
                container.appendChild(card);
            }
        }

        function createTokenCard(tokenId, tokenData, latest) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition';
            
            // Time ranges to display
            const ranges = [
                { key: 'apr_6h', label: '6h' },
                { key: 'apr_12h', label: '12h' },
                { key: 'apr_24h', label: '24h' },
                { key: 'apr_3d', label: '3d' },
                { key: 'apr_7d', label: '7d' },
                { key: 'apr_14d', label: '14d' },
                { key: 'apr_30d', label: '30d' }
            ];

            const aprRows = ranges.map(r => {
                const value = latest[r.key];
                const display = value != null ? value.toFixed(2) + '%' : '-';
                const color = value != null && value > 0 ? 'text-green-400' : 
                             value != null && value < 0 ? 'text-red-400' : 'text-gray-500';
                return `
                    <div>
                        <div class="text-xs text-gray-500">${r.label}</div>
                        <div class="text-sm font-bold font-mono ${color}">${display}</div>
                    </div>
                `;
            }).join('');

            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold">${tokenData.symbol}</h3>
                        <p class="text-sm text-gray-400">${tokenData.name}</p>
                    </div>
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded">${tokenData.protocol}</span>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <div class="text-sm text-gray-400">Current Share Price</div>
                        <div class="text-2xl font-mono">${latest.price.toFixed(8)}</div>
                    </div>
                    
                    <div class="pt-3 border-t border-gray-700">
                        <div class="text-xs text-gray-400 mb-2">Realized APR</div>
                        <div class="grid grid-cols-4 gap-2">
                            ${aprRows}
                        </div>
                    </div>

                    <div class="text-xs text-gray-500 pt-2">
                        ${tokenData.snapshots.length} snapshots | Chain: ${tokenData.chain}
                    </div>
                </div>
            `;

            card.onclick = () => showChart(tokenId);
            return card;
        }

        function setupChart() {
            const select = document.getElementById('token-select');
            select.innerHTML = '<option value="">Select token...</option>';
            
            for (const [tokenId, tokenData] of Object.entries(allData.tokens)) {
                if (tokenData.snapshots.length === 0) continue;
                const option = document.createElement('option');
                option.value = tokenId;
                option.textContent = `${tokenData.symbol} - ${tokenData.name}`;
                select.appendChild(option);
            }

            select.onchange = (e) => {
                if (e.target.value) showChart(e.target.value);
            };
        }

        function showChart(tokenId) {
            const tokenData = allData.tokens[tokenId];
            if (!tokenData) return;

            document.getElementById('token-select').value = tokenId;
            document.getElementById('chart-title').textContent = 
                `${tokenData.symbol} - Share Price History`;

            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) chart.destroy();

            const labels = tokenData.snapshots.map(s => 
                new Date(s.timestamp).toLocaleString()
            );
            const prices = tokenData.snapshots.map(s => s.price);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Share Price',
                        data: prices,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const snap = tokenData.snapshots[context.dataIndex];
                                    const lines = [`Price: ${snap.price.toFixed(8)}`];
                                    const ranges = ['6h', '12h', '24h', '3d', '7d', '14d', '30d'];
                                    ranges.forEach(r => {
                                        const key = `apr_${r}`;
                                        if (snap[key] != null) {
                                            lines.push(`${r} APR: ${snap[key].toFixed(2)}%`);
                                        }
                                    });
                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#9ca3af',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Load on page load
        loadData();

        // Auto-refresh every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
